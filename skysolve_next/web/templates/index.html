<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SkySolve Next</title>
  <!-- Tailwind Play CDN for prototype only. NOT recommended for production. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --muted-red: #7a0000;
      --muted-red-2: #4a0000;
    }
    [data-theme="night"]{
      --bg: #0b0b0b;
      --panel: #111111;
      --text: #e66;
      --accent: var(--muted-red);
      --log-bg: #111;
      --log-fg: #e66;
    }
    [data-theme="day"]{
      --bg: #ffffff;
      --panel: #f6f7f9;
      --text: #111827;
      --accent: #0366d6;
      --log-bg: #222;
      --log-fg: #eee;
    }
    body{background:var(--bg); color:var(--text)}
    .focus-ring:focus{outline:3px solid rgba(255,255,255,0.08); outline-offset:2px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (prefers-color-scheme: dark) {
      [data-theme="day"] { }
    }
    .action-btn {
      min-width: 120px;
      min-height: 44px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      margin-right: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .action-btn:last-child { margin-right: 0; }
    .action-btn:focus { outline: 3px solid #fff2; outline-offset: 2px; }
    .action-btn:hover { background: #0055a5; }
    @media (max-width: 640px) {
      .action-btn { min-width: 80px; font-size: 0.95rem; }
    }
    @media (min-width: 1024px) {
      main { zoom: 0.9; }
    }
    .slider {
      position: relative;
      transition: background 0.2s;
    }
    .dot {
      transition: transform 0.2s;
    }
    #theme-toggle:checked + .slider .dot {
      transform: translateX(24px);
      background: var(--muted-red);
    }
    #theme-toggle:checked + .slider {
      background: #7a0000;
    }
    [data-theme="night"] .action-btn {
      color: #f66;
    }
    [data-theme="night"] .text-white {
      color: #f66 !important;
    }
    [data-theme="night"] .text-gray-300 {
      color: #e66 !important;
    }
    [data-theme="day"] .text-gray-300 {
      color: #222 !important;
    }
    [data-theme="night"] #status-label {
      color: #e66 !important;
    }
    [data-theme="night"] #status-chip {
      color: #e66 !important;
    }
    #preview {
      width: 100%;
      height: auto;
      max-width: 100%;
      display: block;
    }
    [data-theme="night"] .log-area {
      background: #111 !important;
      color: #e66 !important;
    }
  </style>
</head>
<body data-theme="day" class="min-h-screen antialiased">
  <header class="flex items-center justify-between p-4 bg-[var(--panel)]">
    <div class="flex items-center space-x-3">
      <div class="text-xl font-semibold">SkySolve</div>
      <div id="status-chip" class="text-sm px-2 py-1 rounded-md font-semibold" style="background:var(--accent);color:#fff;">Status: <span id="status-label">OK</span></div>
    </div>
    <div class="flex items-center space-x-3">
      <label class="flex items-center cursor-pointer">
        <span class="mr-2">Day</span>
        <input type="checkbox" id="theme-toggle" class="sr-only">
        <span class="slider inline-block w-12 h-6 bg-gray-300 rounded-full relative">
          <span class="dot absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></span>
        </span>
        <span class="ml-2">Night</span>
      </label>
      <button id="settings-btn" class="px-3 py-1 rounded-md border focus-ring">⚙</button>
    </div>
  </header>
  <main class="p-4 max-w-6xl mx-auto w-full">
    <section class="bg-[var(--panel)] rounded-lg p-4 mb-4" aria-live="polite">
      <div class="flex flex-col md:flex-row md:space-x-4">
        <div class="flex-1">
          <div class="mb-3">
            <label class="block text-sm">Image</label>
            <div class="border rounded-md p-3 bg-white/5">
              <img id="preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='360'%3E%3Crect width='100%25' height='100%25' fill='%23222'/%3E%3Ctext x='50%25' y='50%25' fill='%23bbb' font-size='20' text-anchor='middle' alignment-baseline='middle'%3EPreview (Use demo/upload)%3C/text%3E%3C/svg%3E" alt="preview" class="w-full rounded-md" />
            </div>
          </div>
          <form id="solve-form" enctype="multipart/form-data" class="flex items-center space-x-4">
            <input id="file-input" type="file" accept="image/*" class="hidden" name="image" />
            <button id="demo-btn" type="button" class="action-btn">Use Demo</button>
            <button id="upload-btn" type="button" class="action-btn">Upload</button>
            <button id="solve-btn" type="submit" class="action-btn">Solve</button>
            <button id="push-onstep" type="button" class="action-btn">OnStep</button>
          </form>
          <div id="progress" class="mt-3 hidden">
            <div class="text-sm mb-1">Solving…</div>
            <div class="w-full h-2 bg-white/10 rounded"><div id="prog-bar" class="h-2 bg-[var(--accent)] rounded" style="width:30%"></div></div>
          </div>
        </div>
        <aside class="w-full md:w-80 mt-4 md:mt-0">
          <div class="bg-white/5 rounded-md p-3 mb-3">
            <div class="text-xs text-gray-300">Last Solve</div>
            <div id="last-solve" class="mt-2 text-sm"></div>
            <div class="mt-2 text-xs">
              <span>RA:</span> <span id="ra">--</span>
              <span>Dec:</span> <span id="dec">--</span>
              <span>Time:</span> <span id="timestamp">--</span>
              <span>Solver:</span> <span id="solver">--</span>
              <span>Confidence:</span> <span id="confidence">--</span>
            </div>
            <label class="block mt-2"><input type="checkbox" id="auto-solve"> Automatically image and solve</label>
          </div>
          <div class="bg-white/5 rounded-md p-3 mb-3">
            <div class="text-xs text-gray-300">Camera Settings</div>
            <label class="block mt-2">Shutter Speed:
              <select id="shutter-speed" class="w-full rounded-md p-2 bg-white/5 focus-ring">
                <option value="2">2 s</option>
                <option value="1" selected>1 s</option>
                <option value="1/2">1/2 s</option>
                <option value="1/4">1/4 s</option>
                <option value="1/8">1/8 s</option>
                <option value="1/15">1/15 s</option>
                <option value="1/30">1/30 s</option>
                <option value="1/60">1/60 s</option>
                <option value="1/125">1/125 s</option>
                <option value="1/250">1/250 s</option>
                <option value="1/500">1/500 s</option>
                <option value="1/1000">1/1000 s</option>
              </select>
            </label>
            <label class="block mt-2">ISO Speed:
              <select id="iso-speed" class="w-full rounded-md p-2 bg-white/5 focus-ring">
                <option value="2000">2000</option>
                <option value="1600">1600</option>
                <option value="1000" selected>1000</option>
                <option value="800">800</option>
                <option value="400">400</option>
                <option value="200">200</option>
                <option value="100">100</option>
                <option value="60">60</option>
              </select>
            </label>
            <label class="block mt-2">Image Size:
              <select id="image-size" class="w-full rounded-md p-2 bg-white/5 focus-ring">
                <option value="640x480">640x480</option>
                <option value="1280x960" selected>1280x960</option>
              </select>
            </label>
          </div>
          <div class="bg-white/5 rounded-md p-3 mb-3">
            <div class="text-xs text-gray-300">Solver</div>
            <div class="mt-1">
              <select id="solver-select" class="w-full rounded-md p-2 bg-white/5 focus-ring">
                <option value="astrometry">Astrometry.net</option>
                <option value="tetra" disabled>Tetra (if installed)</option>
              </select>
            </div>
            <div class="mt-2 text-xs text-gray-300">Web port: 5001 • LX200 port: 5002</div>
          </div>
          <div class="bg-white/5 rounded-md p-3">
            <div class="text-xs text-gray-300">OnStep</div>
            <div class="mt-1">
              <label class="block mt-1 flex items-center">  <span class="mr-1">http://</span>
                <input type="text" id="onstep-host" class="rounded-md p-2 bg-white/5 focus-ring w-24 mr-1" value="localhost" />
                <span class="mx-1">:</span>
                <input type="number" id="onstep-port" class="rounded-md p-2 bg-white/5 focus-ring w-20" value="5002" min="1" max="65535" />
              </label>
              <label class="block mt-2"><input type="checkbox" id="auto-push"> Push solutions to OnStep</label>
            </div>
          </div>
        </aside>
      </div>
    </section>
    <section class="bg-[var(--panel)] rounded-lg p-4">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">History</h3>
        <button id="clear-history" class="text-sm px-2 py-1 border rounded-md focus-ring">Clear</button>
      </div>
      <ul id="history" class="mt-3 space-y-2 text-sm log-area" style="height: 25em; max-height: 25em; overflow-y: auto; background: var(--log-bg, #222); color: var(--log-fg, #eee); padding: 8px; border-radius: 8px;"></ul>
    </section>
  </main>
  <footer class="fixed left-0 right-0 bottom-0 p-2 bg-[var(--panel)]">
    <div class="max-w-4xl mx-auto flex items-center justify-between text-sm">
      <div>SkySolve • Demo prototype</div>
      <div>Theme: <span id="theme-label">Day</span></div>
    </div>
  </footer>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Theme slider switch
  const themeToggle = document.getElementById('theme-toggle');
  const body = document.body;
  themeToggle.addEventListener('change', function() {
    const isNight = this.checked;
    body.setAttribute('data-theme', isNight ? 'night' : 'day');
    document.getElementById('theme-label').textContent = isNight ? 'Night' : 'Day';
  });
  // Remove broken statusEl logic
  // If you want to show JSON status, add a <pre id="status"></pre> in HTML and uncomment below:
  // const statusEl = document.getElementById('status');
  // function updateStatus() {
  //   fetch('/status').then(r => r.json()).then(j => statusEl.textContent = JSON.stringify(j, null, 2));
  // }
  // updateStatus(); setInterval(updateStatus, 2000);

  // Button and checkbox wiring with debug output
  function debugLog(msg) {
    if (window && window.console) console.log(msg);
  }
  document.getElementById('demo-btn').onclick = function() {
    debugLog('Demo button clicked: POST /solve?demo=1');
    setStatusBadge('Busy');
    fetch('/solve?demo=1', {method:'POST'})
      .then(r => r.json())
      .then(j => {
        debugLog('Demo solve response: ' + JSON.stringify(j));
        setStatusBadge('OK');
        if(j.image_url) {
          const preview = document.getElementById('preview');
          preview.src = "/solve";
        }
        if(j.log) {
          const history = document.getElementById('history');
          const li = document.createElement('li');
          // Render log with line breaks
          li.innerHTML = j.log.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
          history.appendChild(li);
          history.scrollTop = history.scrollHeight;
        }
        // Update Last Solve panel
        if(j.result === 'success') {
          document.getElementById('last-solve').textContent = '';
          document.getElementById('ra').textContent = j.ra !== undefined ? j.ra : '--';
          document.getElementById('dec').textContent = j.dec !== undefined ? j.dec : '--';
          document.getElementById('confidence').textContent = j.confidence !== undefined ? j.confidence : '--';
          document.getElementById('solver').textContent = 'Astrometry.net';
          document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }
      })
      .catch((e) => { debugLog('Demo solve error: ' + e); setStatusBadge('Error'); });
  };
  document.getElementById('upload-btn').onclick = function() {
    debugLog('Upload button clicked: opening file picker');
    document.getElementById('file-input').click();
  };
  document.getElementById('file-input').onchange = function(ev) {
    const f = ev.target.files[0];
    if(!f) return;
    debugLog('File selected: ' + f.name);
    // Show preview image
    const preview = document.getElementById('preview');
    preview.src = URL.createObjectURL(f);
    setStatusBadge('Busy');
    const data = new FormData();
    data.append('image', f);
    fetch('/solve', {method:'POST', body:data})
      .then(r => r.json())
      .then(j => {
        debugLog('Upload solve response: ' + JSON.stringify(j));
        setStatusBadge('OK');
        // updateStatus(); // Only if you add a status element
      })
      .catch((e) => { debugLog('Upload solve error: ' + e); setStatusBadge('Error'); });
  };
  document.getElementById('solve-form').onsubmit = function(e) {
    e.preventDefault();
    debugLog('Solve button clicked: submitting form');
    setStatusBadge('Busy');
    fetch('/solve', {method:'POST'})
      .then(r => r.json())
      .then(j => {
        debugLog('Solve response: ' + JSON.stringify(j));
        setStatusBadge('OK');
        if(j.image_url) {
          const preview = document.getElementById('preview');
          preview.src = "/solve";
        }
        if(j.log) {
          const history = document.getElementById('history');
          const li = document.createElement('li');
          // Render log with line breaks
          li.innerHTML = j.log.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
          history.appendChild(li);
          history.scrollTop = history.scrollHeight;
        }
        // Update Last Solve panel
        if(j.result === 'success') {
          document.getElementById('last-solve').textContent = '';
          document.getElementById('ra').textContent = j.ra !== undefined ? j.ra : '--';
          document.getElementById('dec').textContent = j.dec !== undefined ? j.dec : '--';
          document.getElementById('confidence').textContent = j.confidence !== undefined ? j.confidence : '--';
          document.getElementById('solver').textContent = 'Astrometry.net';
          document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }
      })
      .catch((e) => { debugLog('Solve error: ' + e); setStatusBadge('Error'); });
  };
  document.getElementById('push-onstep').onclick = function() {
    debugLog('OnStep button clicked: POST /onstep/push');
    setStatusBadge('Busy');
    fetch('/onstep/push', {method:'POST'})
      .then(() => {
        debugLog('OnStep push response: success');
        setStatusBadge('OK');
      })
      .catch((e) => { debugLog('OnStep push error: ' + e); setStatusBadge('Error'); });
  };
  document.getElementById('auto-solve').addEventListener('change', function() {
    debugLog('Auto-solve checkbox changed: ' + this.checked);
    setStatusBadge('Busy');
    fetch('/auto-solve', {method:'POST', body: JSON.stringify({enabled: this.checked}), headers: {'Content-Type': 'application/json'}})
      .then(() => { debugLog('Auto-solve response: success'); setStatusBadge('OK'); })
      .catch((e) => { debugLog('Auto-solve error: ' + e); setStatusBadge('Error'); });
  });
  document.getElementById('auto-push').addEventListener('change', function() {
    debugLog('Auto-push checkbox changed: ' + this.checked);
    setStatusBadge('Busy');
    fetch('/auto-push', {method:'POST', body: JSON.stringify({enabled: this.checked}), headers: {'Content-Type': 'application/json'}})
      .then(() => { debugLog('Auto-push response: success'); setStatusBadge('OK'); })
      .catch((e) => { debugLog('Auto-push error: ' + e); setStatusBadge('Error'); });
  });
  // Remove JS that sets previewImg.width/height and only rely on CSS for sizing
  // Example: update status badge (simulate status)
  function setStatusBadge(status) {
    const label = document.getElementById('status-label');
    label.textContent = status;
    const chip = document.getElementById('status-chip');
    if(status === 'OK') {
      chip.style.background = 'var(--accent)';
      chip.style.color = '#fff';
    } else if(status === 'Busy') {
      chip.style.background = '#f6c700';
      chip.style.color = '#222';
    } else if(status === 'Error') {
      chip.style.background = '#c00';
      chip.style.color = '#fff';
    }
  }
  // On page load, ensure status badge text is white
  setStatusBadge('OK');

  // Load settings from backend and update UI
  fetch('/settings').then((r) => r.json()).then(settings => {
    // Camera settings
    document.getElementById('shutter-speed').value = settings.camera.shutter_speed;
    document.getElementById('iso-speed').value = settings.camera.iso_speed;
    document.getElementById('image-size').value = settings.camera.image_size;
    // Solver settings
    document.getElementById('solver-select').value = settings.solver.type;
    // OnStep settings
    document.getElementById('onstep-host').value = settings.onstep.host;
    document.getElementById('onstep-port').value = settings.onstep.port;
  });

  // Save settings to backend when changed
  function saveSetting(section, key, value) {
    fetch('/settings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({[section]: {[key]: value}})
    });
  }
  document.getElementById('shutter-speed').addEventListener('change', function() {
    saveSetting('camera', 'shutter_speed', this.value);
  });
  document.getElementById('iso-speed').addEventListener('change', function() {
    saveSetting('camera', 'iso_speed', this.value);
  });
  document.getElementById('image-size').addEventListener('change', function() {
    saveSetting('camera', 'image_size', this.value);
  });
  document.getElementById('solver-select').addEventListener('change', function() {
    saveSetting('solver', 'type', this.value);
  });
  document.getElementById('onstep-host').addEventListener('change', function() {
    saveSetting('onstep', 'host', this.value);
  });
  document.getElementById('onstep-port').addEventListener('change', function() {
    saveSetting('onstep', 'port', this.value);
  });
  document.getElementById('clear-history').onclick = function() {
    const history = document.getElementById('history');
    history.innerHTML = "";
  };
});
</script>
</body>
</html>
