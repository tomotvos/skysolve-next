# SkySolve Next — Gap Analysis (2025-09-02)

This document compares the requirements from the PRD and Implementation Plan against the current codebase and implementation. It identifies missing features and tasks required to achieve full parity and meet project goals.

---

## 1. Summary of Requirements (from PRD & Implementation Plan)

- **Image solving**: Astrometry.net (default), Tetra3 (fast path on Pi), fallback logic.
- **Pi camera integration**: Picamera2/libcamera for field image capture (exposure, gain/ISO, ROI/binning, cadence ~2–5s).
- **Web UI**: Day/night mode, status, image preview, settings, live updates via WebSocket.
- **LX200 server**: Read-only, SkySafari compatible, correct command set, batched/partial command handling.
- **OnStep client**: Optional, disabled by default, sync after solve, safety threshold logic.
- **Demo mode**: For UI/SkySafari testing without hardware.
- **Configurable ports/settings**: Solver selection, OnStep config, environment file.
- **Systemd/mDNS**: Service definitions, Avahi advertising.
- **Structured logging/metrics**: JSON logs, diagnostics, `/metrics` endpoint.
- **Security**: Read-only LX200, network exposure guidance, future authentication.
- **Packaging for Pi**: Install script, venv, systemd, cross-build artifacts.
- **Unit/integration tests, CI**: Mock servers, coverage for all major features.

---

## 2. Current State

- Astrometry.net solver integrated and working.
- Tetra3 solver: only placeholder, not implemented.
- Demo mode and image upload supported.
- LX200 server implemented, read-only, SkySafari compatible.
- OnStep client exists, but may lack robust error handling and full sync logic.
- Web UI supports day/night mode, status, image upload, solver selection, OnStep config.
- Systemd unit files exist in `services/`, not in `packaging/systemd/`.
- mDNS/Avahi service files present.
- Logging is basic; not structured JSON.
- No `/metrics` endpoint.
- Security guidance documented; code enforces read-only LX200.
- Packaging and install script for Pi present.
- Unit/integration tests exist for core logic; coverage for OnStep and Tetra incomplete.
- No direct Pi camera (Picamera2/libcamera) integration for field image capture.
- No API documentation in `docs/api.md`.
- No e2e UI test.
- No PR template or contribution guidelines.

---

## 3. Gaps Identified

1. **Pi Camera Integration**
   - PRD explicitly requires Picamera2/libcamera support for field image capture.
   - Not implemented in codebase; only demo/upload supported.

2. **Tetra3 Solver Integration**
   - Required as fast path on Pi; only placeholder exists.

3. **Structured Logging & Metrics**
   - Structured JSON logs and `/metrics` endpoint are required.
   - Current logging is plain text; no metrics endpoint.

4. **API Documentation**
   - `docs/api.md` with endpoint examples is missing.

5. **Systemd Unit File Location**
   - Should be in `packaging/systemd/`, currently only in `services/`.

6. **End-to-End UI Test**
   - Required for CI; not present.

7. **OnStep Client Robustness**
   - Needs retries, backoff, and safety threshold logic per PRD.

8. **Image Pre-processing Pipeline**
   - Stretch goal; not present.

9. **PR Template & Contribution Guidelines**
   - Not present.

10. **Authentication**
    - Not implemented (future/optional).

11. **Cross-platform Camera Support**
    - Only Pi camera mentioned; USB camera support not specified or implemented.

12. **Automated Image Capture Scheduling**
    - Not implemented (optional/stretch).

---

## 4. Updated Checklist of Remaining Tasks

### Must-Have
- [ ] Integrate Picamera2/libcamera for direct Pi image capture.
- [ ] Implement Tetra3 solver integration and fallback logic.
- [x] Add structured JSON logging and include `solve_time_ms`, `solver`, `image_id`.
- [ ] Implement `/metrics` endpoint for Prometheus.
- [ ] Move systemd unit file to `packaging/systemd/`.
- [x] Write API documentation in `docs/api.md`.
- [ ] Add robust error handling, retries, and safety threshold logic to OnStep client.
- [ ] Add end-to-end UI test for solve flow.
- [ ] Expand unit/integration tests for OnStep and Tetra.

### Stretch/Optional
- [ ] Implement image pre-processing pipeline (debayer, star detection, quality filters).
- [ ] Add PR template and contribution guidelines.
- [ ] Add authentication for web API (future/optional).
- [ ] Support cross-platform camera devices (USB, PiCam).
- [ ] Add automated image capture scheduling/triggering.

---

*Generated by GitHub Copilot on 2025-09-02*
